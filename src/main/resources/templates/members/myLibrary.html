<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default_layout}">
<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
</head>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

<body>
<div layout:fragment="content">

    <h1>여기는 내서재임</h1>
    <a th:href="@{../calendar/{pk}(pk=${session.myLibraryPk})}">bookcalendar</a>
    <div>
        <div th:each="book, bookStat : ${bookList}">
            <div>
                <hr>
                <!-- Button trigger modal -->
                <button type="button" class="btn btn-light open-modal" data-bs-toggle="modal"
                        th:attr="data-bs-target='#exampleModal' + ${bookStat.index},
                            data-book-pk=${book.bookPk},
                            data-index=${bookStat.index},
                            data-user=${session.pk},
                            data-name=${session.name}">
                    <img th:src="${book.coverImagePath}" alt="북커버">
                </button>
                <input type="hidden" th:text="${book.bookPk}">
                <p th:text="${book.bookTitle}" readonly/>
                <p th:text="${book.bookAuthor}" readonly/>
                <p th:text="${book.bookCategory}" readonly/>
                <p th:text="${book.bookContent}" readonly/>
                <p th:text="${book.bookPrice}" readonly/>
                <p th:text="${book.bookPublisher}" readonly/>
                <p th:text="${book.bookPublishDate}" readonly/>
                <hr>
            </div>

            <!-- Modal -->
            <div class="modal fade" th:id="'exampleModal' + ${bookStat.index}" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h1 class="modal-title fs-5" id="exampleModalLabel">Modal title</h1>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <h1>Comment List (미치겠어요~)</h1>
                            <div th:id="'commentsContainer' + ${bookStat.index}"> <!-- 책들 마다 인덱스 부여 -->
                                <!-- 코멘트가 표시되는 곳 -->
                            </div>
                            <button id="searchMoreNotify">더보기</button>
                            <!-- 코멘트 작성 폼-->
                            <form id="commentForm" th:action="@{/comments/insert}" method="post" onsubmit="submitForm();">
                                <input type="hidden" th:name="book_pk" th:value="${book.bookPk}">
                                <input type="hidden" th:name="member_pk" th:value="${session.pk}">
                                <!--<div>
                                    <p type="text" id="member_pk" name="member_pk" th:value="${session.pk}" th:text="${session.name}" required>
                                </div>-->
                                <div>
                                    <label for="comment_title">제목</label>
                                    <input type="text" id="comment_title" name="comment_title" placeholder="제목을 입력하시오" required>
                                    <div class="error-message" id="titleError"></div>
                                </div>
                                <div>
                                    <label for="comment_content">내용</label>
                                    <textarea id="comment_content" name="comment_content" cols="50" rows="5" placeholder="내용을 입력하시오" required></textarea>
                                    <div class="error-message" id="contentError"></div>
                                </div>
                                <button type="submit" id="submitCommentBtn" >등록</button>
                                <button type="reset" class="btn btn-secondary" >취소</button>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <!--<button type="button" class="btn btn-primary">Save changes</button>-->
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>

        //document.getElementById('commentForm').addEventListener('submit', function(e) {
        function submitForm() {
            e.preventDefault(); // 기본 폼 제출 동작을 방지
            var form = document.getElementById('commentForm');
            var formData = new FormData(form); // 폼 데이터 수집
            var my_library_pk = lastSegment;

            fetch(this.action, {
                method: 'POST',
                body: formData,
                my_library_pk : my_library_pk
            })
                .then(response => {
                    if(response.ok) {
                        // 성공적으로 데이터가 처리되었을 때 페이지 새로고침
                        window.location.reload();
                        alert("코멘트가 등록되었습니다.");
                    } else {
                        // 서버에서 오류 응답이 올 경우 처리
                        alert('코멘트 등록이 불가합니다. 다시 시도해주세요');
                    }
                })
                .catch(error => console.error('Error:', error));

            document.getElementById("commentForm").reset();
        }

        //url에서 my_library_pk 값 가져오기
        var url = window.location.href;
        const lastSegment = url.split('/').pop();
        //console.log(lastSegment);

        $(document).ready(function() {
            $('.open-modal').click(function () {
                // 페이지 번호 초기화
                window.pageNum = 1;

                // commentsContainer 변수를 여기에서 초기화
                var commentsContainer = $('#commentsContainer');

                // commentsContainer 내용 초기화
                commentsContainer.empty();

                // 필요한 데이터 로드
                var pageSize = 2;     //2개씩 로딩
                var user = $(this).data('user');
                var name = $(this).data('name');
                console.log(name);
                var bookPk = $(this).data('book-pk');
                var myLibraryPk = lastSegment;
                var index = $(this).data('index'); // 인덱스

                // 댓글 로드 함수 호출
                loadComments(window.pageNum);

                // 더보기 버튼 이벤트 핸들러 초기화
                $('#searchMoreNotify').off('click').on('click', function(){
                    window.pageNum++; // 페이지 번호 증가
                    loadComments(window.pageNum);
                });

                function loadComments(pageNum) {
                    console.log(bookPk);
                    console.log(myLibraryPk);
                    console.log(window.pageNum);
                    $.ajax({
                        url: '/comments/list',
                        type: 'POST',
                        contentType: 'application/json',    // 서버로 보내는 데이터의 타입
                        dateType: JSON,                     // 서버로부터 받아올 데이터의 타입
                        data: JSON.stringify({pageNum: pageNum, pageSize: pageSize, bookPk: bookPk, myLibraryPk: myLibraryPk}),
                        success: function (data) {
                            console.log(data);
                            if (window.pageNum === 1) { // 첫 페이지일 경우, 코멘트 컨테이너를 초기화
                                $('#commentsContainer' + index).empty();
                            }

                            const commentsContainer = document.getElementById('commentsContainer' + index);
                            data.forEach(function(comment) {
                                var commentHtml = `<div class="card shadow border-0 rounded-4 mb-5">
                                                         <div class="card-body p-5">
                                                              <div class="row align-items-center gx-5">
                                                                  <div class="col text-center text-lg-start mb-4 mb-lg-0">
                                                                    <div class="bg-light p-4 rounded-4">
                                                                        <div class="text-primary fw-bolder mb-2">
                                                                            작성 일자: ${comment.created_date} <br>
                                                                            ${comment.modified_date ? `수정 일자: ${comment.modified_date} <br>` : ''}
                                                                        </div>
                                                                        <div class="small text-muted">작성자: ${name}
                                                                        <button class="fas fa-heart" data-liked="false" onclick="likeComment(this, ${comment.comment_pk}, ${comment.member_pk})"></button> ${comment.total_like} &nbsp;&nbsp;
                                                                        <button class="fas fa-flag" onclick="reportComment(${comment.comment_pk}, ${comment.member_pk})"></button><br>
                                                                        </div>
                                                                        <div class="small fw-bolder">제목: ${comment.comment_title}</div>
                                                                    </div>
                                                                  </div>
                                                                <div class="col-lg-8"><div>내용: ${comment.comment_content}</div></div>
                                                              </div>
                                                         </div>
                                                   </div>`;
                                // 사용자 ID와 댓글 작성자 ID가 같을 경우에만 수정 및 삭제 버튼 추가
                                if (user === comment.member_pk) {
                                    commentHtml += `<form>
                                                    <input type="button" class="btn btn-primary" value="수정" onclick="openEditModal(${comment.comment_pk})">
                                                    <input type="button" class="btn btn-secondary" value="삭제" onclick="isDelete(${comment.comment_pk})">
                                                </form>`;
                                }
                                // commentsContainer에 댓글 요소 추가
                                $(commentsContainer).append(commentHtml);

                            });
                            // 더보기 버튼 보이기/숨기기 처리
                            if(data.length < pageSize) {
                                $('#searchMoreNotify').hide();
                            }else {
                                $('#searchMoreNotify').show(); // 더 불러올 데이터가 있을 경우 "더보기" 버튼을 다시 보이게 합니다.
                            }
                        },
                        error: function (err) {
                            console.log('Error:', err);
                        }
                    });
                }

            });
        });

        //코멘트 수정
        function openEditModal(comment_pk) {
            console.log(comment_pk);
            var url = "/comments/updateComment?comment_pk=" + comment_pk;
            var width = 600; // 창의 너비
            var height = 400; // 창의 높이
            //오픈 시 화면 가운데에 위치
            var left = window.screen.width / 2 - width / 2;
            var top = window.screen.height / 2 - height / 2;

            //미니창 오픈
            window.open(url, "Comment Edit", "width=" + width + ",height=" + height + ",top=" + top + ",left=" + left);
            //window.open(url, "Comment Edit", "width=600,height=400");
        }

        //삭제 확인 여부
        function isDelete(comment_pk) {
            var is_delete = confirm("정말 삭제하시겠습니까?");
            if (is_delete) {
                deleteComment(comment_pk)
            }
        }
        // 댓글 삭제
        function deleteComment(comment_pk) {
            console.log(`Deleting comment ${comment_pk}`);
            fetch(`/comments/delete/${comment_pk}`, {
                method: 'DELETE'
            })
                .then(response => {
                    if(response.ok) {
                        // 요청이 성공적으로 완료되면, 해당 댓글 요소를 제거
                        const commentElement = document.getElementById(`comment-${comment_pk}`);
                        if(commentElement) {
                            commentElement.remove();
                        }
                        console.log('코멘트가 성공적으로 삭제되었습니다.');
                        alert("코멘트가 삭제 되었습니다.");
                        location.reload();

                    } else {
                        // 서버로부터 오류 응답을 받았을 때 처리
                        console.error('코멘트 삭제 중 오류가 발생했습니다.');
                    }
                })
                .catch((error) => {
                    console.error('Error:', error);
                });
        }

        //좋아요
        //좋아요
        function likeComment(button, comment_pk, member_pk) {
            const isLiked = button.getAttribute('data-liked') === 'true';

            // 좋아요 상태를 토글합니다.
            button.setAttribute('data-liked', !isLiked);

            // 버튼 색상을 변경합니다.
            button.style.color = !isLiked ? 'red' : 'black'; // 좋아요 상태에 따라 색상을 변경

            // 적절한 액션을 수행합니다.
            if (!isLiked) {
                // 좋아요 등록
                registerLike(comment_pk, member_pk);
            } else {
                // 좋아요 취소
                cancelLike(comment_pk, member_pk);
            }
        }


        function registerLike(comment_pk, member_pk) {
            // AJAX 요청을 통해 서버에 좋아요 등록을 요청합니다.
            fetch(`/comments/likes/${comment_pk}/${member_pk}`, {
                method: 'POST'
            }).then(response => {
                if (!response.ok) {
                    throw new Error('Failed to register like');
                }
                console.log('Like registered');
            }).catch(error => {
                console.error('Error:', error);
            });
        }

        function cancelLike(comment_pk, member_pk) {
            // AJAX 요청을 통해 서버에 좋아요 취소를 요청합니다.
            fetch(`/comments/likes/${comment_pk}/${member_pk}`, {
                method: 'DELETE'
            }).then(response => {
                if (!response.ok) {
                    throw new Error('Failed to cancel like');
                }
                console.log('Like canceled');
            }).catch(error => {
                console.error('Error:', error);
            });
        }

        //신고
        function reportComment(comment_pk, member_pk){
            console.log(comment_pk);
            var url = "/comments/report?comment_pk=" + comment_pk + "&member_pk=" + member_pk;
            var width = 600; // 창의 너비
            var height = 400; // 창의 높이
            //오픈 시 화면 가운데에 위치
            var left = window.screen.width / 2 - width / 2;
            var top = window.screen.height / 2 - height / 2;

            //미니창 오픈
            window.open(url, "Comment Edit", "width=" + width + ",height=" + height + ",top=" + top + ",left=" + left);

        }

    </script>

</div>
</body>
</html>